<meta name="viewport" content="width=device-width, initial-scale=1"/>
<script src="/blog/scripts/fallback.js" nomodule></script>
<script type="importmap">
  {
    "imports": {
      "da-y-wrapper": "https://da.live/deps/da-y-wrapper/dist/index.js",
      "da-lit": "https://da.live/deps/lit/dist/index.js"
    }
  }
</script>
<script>
  const libs = (() => {
    const { hostname, search } = window.location;
    if (!['.aem.', '.hlx.', '.stage.', 'local'].some((i) => hostname.includes(i))) return '/libs';
    const branch = new URLSearchParams(search).get('milolibs') || 'main';
    if (branch === 'local') return 'http://localhost:6456/libs';
    return branch.includes('--') ? `https://${branch}.aem.live/libs` : `https://${branch}--milo--adobecom.aem.live/libs`;
  })();

  const miloStyles = document.createElement('link');
  const miloUtils = document.createElement('link');

  miloStyles.setAttribute('as', 'style');
  miloStyles.setAttribute('href', `${libs}/styles/styles.css`);
  miloUtils.setAttribute('as', 'script');
  miloUtils.setAttribute('crossorigin', 'true');
  miloUtils.setAttribute('href', `${libs}/utils/utils.js`);

  [miloStyles, miloUtils].forEach((tag) => tag.setAttribute('rel', 'preload'));
  document.head.append(miloStyles, miloUtils);

  const sheetSchema = document.querySelector('[type="application/ld+json"]');

  const schema = {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": 'Adobe for Business', 
    "url": window.location.href 
  }

  const jsonLD = document.createElement('script');
  jsonLD.setAttribute('type', 'application/ld+json');
  jsonLD.innerText = JSON.stringify(schema);
  sheetSchema ? sheetSchema.after(jsonLD) : document.head.append(jsonLD);

  (() => {
    function buildLink(language, url) {
      const link = document.createElement('link');
      link.setAttribute('rel', 'alternate');
      link.setAttribute('hreflang', language);
      link.setAttribute('href', url);
      return link;
    }

    const userAgentMeta = document.querySelector('meta[name="hreflinksuseragents"]');
    const allowedAgents = userAgentMeta && userAgentMeta.content.split(',');
    const userAgentString = window.navigator.userAgent;
    const isAllowedAgent = allowedAgents && allowedAgents.some((agent) => userAgentString.includes(agent.trim()));

    const LOCALES = ['jp', 'kr', 'de', 'fr', 'au', 'uk'];

    async function fetchAndParseSitemap() {
      const sitemapOrigin = 'https://business.adobe.com';
      const { origin, pathname } = window.location;

      let sitemapPath = 'sitemap.xml';
      const localeMatch = LOCALES.find(locale => pathname.startsWith(`/${locale}/`));

      if (localeMatch) {
        sitemapPath = `sitemap-${localeMatch}.xml`;
      }
      
      try {
        const response = await fetch(`${origin}/blog/${sitemapPath}`);
        if (!response.ok) return;
        
        const xmlText = await response.text();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
        const parseError = xmlDoc.querySelector('parsererror');
        if (parseError) return;
        
        const urlElements = xmlDoc.querySelectorAll('url');
        let currentUrlElement = null;
        const currentPageUrl = pathname !== '/' ? `${sitemapOrigin}${pathname}` : `${sitemapOrigin}/`;

        for (const urlElement of urlElements) {
          const loc = urlElement.querySelector('loc')?.textContent;
          if (loc === currentPageUrl || loc === currentPageUrl.replace(/\/$/, '')) {
            currentUrlElement = urlElement;
            break;
          }
        }
        
        if (!currentUrlElement) {
          console.warn('Current page not found in sitemap');
          return;
        }
        
        const alternateLinks = currentUrlElement.querySelectorAll('link[rel="alternate"]');
        const linkElements = [];

        alternateLinks.forEach(altLink => {
          const hreflang = altLink.getAttribute('hreflang');
          const href = altLink.getAttribute('href');
          
          if (hreflang && href) {
            linkElements.push(buildLink(hreflang, href));
          }
        });
        
        const titleElement = document.head.querySelector('title');
        if (linkElements.length > 0 && titleElement) {
          titleElement.after(...linkElements);
        }
      } catch (error) {
        console.error('Error fetching or parsing sitemap:', error);
      }
    }
    
    if (isAllowedAgent) {
      fetchAndParseSitemap();
    }
  })();

</script>
<script src="/blog/scripts/scripts.js" type="module"></script>
<style>body { display: none; }</style>
<link rel="icon" href="data:,">
